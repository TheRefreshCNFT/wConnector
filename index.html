<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>QArt Code Gen – Access</title>
  <style>
    :root {
      --gap: 1rem;
      --pad: .5rem;
      --primary: #2196F3;
      --primary-dark: #1976D2;
      --secondary: #21CBF3;
      --text: #333;
      --text-light: #666;
      --bg: #f8f9fa;
      --card-bg: #fff;
      --border: #e0e0e0;
      --success: #4CAF50;
      --error: #f44336;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #000; /* app background will show once gate is gone */
      color: var(--text);
      line-height: 1.6;
      overflow: hidden; /* prevent outer scrollbars, app handles its own */
    }

    /* --- APP WRAPPER (underneath overlay) --- */
    #appWrapper {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    #qartFrame {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      border: 0;
      display: block;
    }

    /* --- GATE OVERLAY --- */
    #gateOverlay {
      position: fixed;
      inset: 0;
      background: var(--bg);
      z-index: 10;
      display: flex;
      flex-direction: column;
    }

    header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      text-align: center;
      padding: 2rem var(--pad);
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }

    #description {
      font-size: 1.2rem;
      opacity: 0.9;
      margin-bottom: 1.5rem;
    }

    #instructions {
      font-size: 1rem;
      margin: 1rem 0;
    }

    #walletStatus {
      background: rgba(255,255,255,0.15);
      border-radius: 50px;
      padding: 0.5rem 1.5rem;
      display: inline-block;
      margin-top: 1rem;
      font-weight: 500;
      backdrop-filter: blur(5px);
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      width: 100%;
      padding: 0 var(--pad);
    }

    .card {
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
      padding: 2rem;
      margin: 2rem auto;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1rem;
    }

    button {
      padding: 0.8rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 1rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    #connectBtn {
      background: white;
      color: var(--primary);
    }

    #connectBtn:hover {
      background: #f5f5f5;
      transform: translateY(-2px);
    }

    #connectBtn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    select, input {
      padding: 0.8rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
      width: 100%;
    }

    select {
      flex: 1;
      background: white;
    }

    .hidden {
      display: none !important;
    }

    .access-message {
      margin-top: 1rem;
      font-size: 1rem;
      color: var(--text-light);
    }

    .access-message strong {
      color: var(--success);
    }

    .access-message.error {
      color: var(--error);
    }

    .access-message a {
      color: var(--primary-dark);
      text-decoration: underline;
    }

    @media(max-width: 600px){
      .row {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
</head>
<body>

  <!-- APP AREA (hidden until gate passes) -->
  <div id="appWrapper" class="hidden">
    <!-- Load your existing QArt app here -->
    <iframe id="qartFrame" src=""></iframe>
  </div>

  <!-- WALLET GATE OVERLAY -->
  <div id="gateOverlay">
    <header>
      <div class="container">
        <h1>QArt Code Gen</h1>
        <p id="description">Exclusive access for Fre5h holders</p>
        <p id="instructions">Connect a Cardano wallet that holds at least 10 assets from the Fre5h policy to enter.</p>

        <div class="row">
          <select id="walletSelect">
            <option value="">Select Wallet…</option>
            <!-- Wallets will be populated dynamically -->
          </select>
          <button id="connectBtn" disabled>Connect Wallet</button>
        </div>

        <div id="walletStatus" class="hidden"></div>
      </div>
    </header>

    <div class="container">
      <div class="card">
        <h2>Access Gate</h2>
        <p>
          This gate checks your connected wallet for Fre5h assets from the required policy.
          If 10 or more are found, the QArt Code Gen app will open.
        </p>
        <p id="accessMessage" class="access-message"></p>
      </div>
    </div>
  </div>

<script type="module">
  import { BrowserWallet } from 'https://esm.sh/@meshsdk/core@1.9.0-beta.62?bundle';

  const sel           = document.getElementById('walletSelect');
  const btn           = document.getElementById('connectBtn');
  const walletStatus  = document.getElementById('walletStatus');
  const accessMessage = document.getElementById('accessMessage');
  const gateOverlay   = document.getElementById('gateOverlay');
  const appWrapper    = document.getElementById('appWrapper');
  const qartFrame     = document.getElementById('qartFrame');

  // Fixed policy ID to check (no user prompt)
  const POLICY_ID = 'adc5716393953403109c335e68c0384238fd19653e960e03afa1fb1f';

  let meshWallet, userAddress;

  // Handle download requests from the QArt iframe
  window.addEventListener('message', (event) => {
    const data = event.data;
    if (!data || data.type !== 'qartDownload') return;

    const href = data.href;
    const filename = data.filename || 'qart.png';

    try {
      const link = document.createElement('a');
      link.href = href;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    } catch (e) {
      console.error('Top-level download failed, opening in new tab.', e);
      try {
        window.open(href, '_blank');
      } catch (err) {
        console.error('window.open also failed:', err);
      }
    }
  });

  async function detect() {
    const wallets = await BrowserWallet.getInstalledWallets();
    if (!wallets.length) {
      sel.innerHTML = '<option>(no wallets detected)</option>';
      return;
    }
    // Keep same sort behavior
    wallets.sort((a, b) => (a === 'mesh' ? -1 : b === 'mesh' ? 1 : 0));
    sel.innerHTML = wallets
      .map(
        (w) =>
          `<option value="${w.name}">${w.name
            .charAt(0)
            .toUpperCase()}${w.name.slice(1)}</option>`
      )
      .join('');
    sel.value = wallets[0].name;
    btn.disabled = false;
  }

  async function checkPolicyAssets() {
    if (!meshWallet) return;

    // Show "Checking Wallet" while the scan is running
    walletStatus.classList.remove('hidden');
    walletStatus.textContent = 'Checking Wallet…';
    accessMessage.textContent = '';
    accessMessage.classList.remove('error');

    try {
      // Mesh aggregates across all addresses in the wallet
      const assets = await meshWallet.getAssets();

      let count = 0;
      for (const asset of assets) {
        if (asset.policyId === POLICY_ID) {
          count++;
        }
      }

      if (count >= 10) {
        walletStatus.textContent =
          `Found ${count} asset${count === 1 ? '' : 's'} from the policy in this wallet. ✅ Access granted.`;
        accessMessage.innerHTML = '<strong>Access granted. Loading QArt Code Gen…</strong>';

        // When the QArt app iframe finishes loading, push the wallet address into it
        qartFrame.onload = () => {
          try {
            if (
              qartFrame.contentWindow &&
              typeof qartFrame.contentWindow.setInitialAddress === 'function'
            ) {
              qartFrame.contentWindow.setInitialAddress(userAddress);
            }
          } catch (err) {
            console.error('Unable to set initial address in QArt app:', err);
          }
        };

        // Load the app into the iframe and remove the gate overlay
        qartFrame.src = 'qart.html'; // make sure qart.html is in the same folder
        appWrapper.classList.remove('hidden');
        gateOverlay.classList.add('hidden');
      } else {
        walletStatus.textContent =
          `Found ${count} asset${count === 1 ? '' : 's'} from the policy in this wallet.`;
        accessMessage.classList.add('error');
        accessMessage.innerHTML =
          `Sorry you don&#39;t have the required assets, get Fre5h ` +
          `<a href="https://www.jpg.store/collection/therefresh" target="_blank" rel="noopener noreferrer">here</a>.`;
      }
    } catch (err) {
      console.error(err);
      walletStatus.textContent = 'Error checking wallet assets.';
      accessMessage.classList.add('error');
      accessMessage.textContent = 'An error occurred while checking your wallet. Please try again.';
    }
  }

  async function connect() {
    const name = sel.value;
    if (!name) return alert('Select a wallet');
    btn.disabled = true;
    btn.textContent = 'Connecting…';
    try {
      meshWallet = await BrowserWallet.enable(name);
      userAddress = await meshWallet.getChangeAddress();
      btn.textContent = `Connected: ${name}`;
      sel.disabled = true;
      console.log('Connected address:', userAddress);

      // Run the policy check in the background right after connection
      checkPolicyAssets();
    } catch (e) {
      console.error(e);
      alert('Connection failed: ' + e.message);
      btn.textContent = 'Connect Wallet';
      btn.disabled = false;
    }
  }

  document.addEventListener('DOMContentLoaded', detect);
  btn.addEventListener('click', connect);
</script>
</body>
</html>


